var token = "7849305390:AAHsD9O-IhGyLnCJPxOoIg1a_acn5spNOFA"; // GANTI DENGAN TOKEN BOT ANDA!
const adminBot = 2109541199; // GANTI DENGAN ID ADMIN ANDA!
const spreadsheetId = "10TupgRfroPas2SjNNY19Q4uB82AYGUVwIIisBxb9Mgg"; // GANTI DENGAN ID SPREADSHEET ANDA!
const debug = false;

// --- Fungsi utama (doPost) ---
function doPost(e) {
    try {
        if (debug) {
            telegram.sendMessage(adminBot, JSON.stringify(e, null, 2)); // Menggunakan library
        }

        let update = JSON.parse(e.postData.contents);

        Logger.log("doPost dijalankan!");
        Logger.log("Update yang diterima: " + JSON.stringify(update, null, 2));

        // Handle inline queries
        if (update.inline_query) {
            handleInlineQuery(update.inline_query);
            return;
        }

        // Handle callback queries
        if (update.callback_query) {
            handleCallbackQuery(update.callback_query);
            return;
        }

        // Handle pesan biasa
        if (update.message) {
            let msg = update.message;
            Logger.log("Pesan diterima: " + JSON.stringify(msg, null, 2));

            if (msg.from.id == adminBot) {
                if (msg.text == "/start") {
                    startCommand(msg);
                } else if (msg.forward_from || msg.forward_from_chat || msg.photo || msg.document) {
                    saveForwardedMessage(msg);
                } else {
                    telegram.sendMessage(adminBot, "Perintah tidak dikenali atau tidak ada file/forward yang diproses."); // Menggunakan library
                }
            } else {
                telegram.sendMessage(msg.chat.id, "Maaf, saya hanya merespons perintah dari admin."); // Menggunakan library
            }
        }
    } catch (error) {
        Logger.log("Error di doPost: " + error.message);
        Logger.log("Stack trace: " + error.stack);
        telegram.sendMessage(adminBot, "Terjadi error: " + error.message); // Menggunakan library
    }
}

// --- Handler Commands dan Callbacks ---

function startCommand(msg) {
    let keyboard = [
        [{ text: "Cari File", switch_inline_query_current_chat: "" }],
        [{ text: "Bantuan", callback_data: "help" }],
    ];
    sendMsgKeyboardInline(msg, "Selamat datang! Gunakan tombol di bawah untuk mencari file atau mendapatkan bantuan.", keyboard);
}

function handleInlineQuery(inlineQuery) {
    try {
        let query = inlineQuery.query;
        let limit = 50; // Batas 50 hasil

        let results = searchFiles(query, limit); // Panggil searchFiles dengan query dan limit

        // Buat teks untuk switch_pm_text (pesan di atas hasil)
        let switchPmText = "";
        if (query.trim() === "") { // Jika query kosong
            switchPmText = "Silakan ketik kata kunci untuk mencari...";
        } else { // Jika ada kata kunci
            switchPmText = `Hasil: ada ${results.length} untuk '${query}'`;
        }

        // Konversi hasil ke format JSON yang benar
        let stringifiedResults = results.map(result => JSON.stringify(result));

        // Buat objek respons untuk answerInlineQuery
        let response = {
            inline_query_id: inlineQuery.id,
            results: "[" + stringifiedResults.join(",") + "]", // Gabungkan hasil dengan koma
            cache_time: 10,
            switch_pm_text: switchPmText,  // Tambahkan pesan di atas hasil
            switch_pm_parameter: "start", // Parameter opsional untuk deep linking
        };

        Logger.log("response inline =" + JSON.stringify(response));
        telegram.request("answerInlineQuery", response); // Menggunakan library

    } catch (error) {
        Logger.log("Error di handleInlineQuery: " + error.message);
        Logger.log("Stack trace: " + error.stack);
        telegram.sendMessage(adminBot, "Error di handleInlineQuery: " + error.message); // Menggunakan library
    }
}
function handleCallbackQuery(callbackQuery) {
    try {
        let data = callbackQuery.data;
        let cb = callbackQuery;
        Logger.log("handleCallbackQuery - Data: " + data);

        if (data === "help") {
            let pesan = "<b>Bantuan:</b>\n\n" +
                "Admin dapat mengunggah file (foto/dokumen) ke bot, atau meneruskan pesan ke bot. " +
                "File akan disimpan di Google Sheet. Pengguna dapat mencari file tersebut melalui pencarian inline " +
                "(ketik @nama_bot_kamu [spasi] query di chat mana pun).";  // Ganti @nama_bot_kamu
            sendMsgKeyboardInline2(cb, pesan, []);
        }
        telegram.answerCallbackQuery(callbackQuery.id, "Perintah diterima!"); // Perubahan di sini
    }   catch (error) {
        Logger.log("Error di handleCallbackQuery: " + error.message);
        Logger.log("Stack trace: " + error.stack);
        telegram.sendMessage(adminBot, "Error di handleCallbackQuery: " + error.message); // Perubahan di sini
    }
}

// --- Fungsi Penyimpanan Data ---

function saveForwardedMessage(msg) {
    try {
        let fileId, fileName, fileType, caption, uploadedBy, messageLink;

        // Mendapatkan link pesan
        if (msg.forward_from_chat && msg.forward_from_chat.username) {
            messageLink = "https://t.me/" + msg.forward_from_chat.username + "/" + msg.forward_from_message_id;
        } else if (msg.forward_from_chat) {
            messageLink = "private chat/channel";
        } else if (msg.forward_sender_name) {
            messageLink = "forwarded from " + msg.forward_sender_name;
        } else {
            messageLink = "Unknown";
        }

        uploadedBy = msg.from.id;
        caption = msg.caption ? msg.caption : "";

        if (msg.photo) {
            let photo = msg.photo[msg.photo.length - 1];
            fileId = photo.file_id;
            fileName = "photo_" + fileId + ".jpg";
            fileType = "photo";
        } else if (msg.document) {
            fileId = msg.document.file_id;
            fileName = msg.document.file_name;
            fileType = "document";
        }

        Logger.log("saveForwardedMessage - File: " + fileName + ", Type: " + fileType + ", fileId: " + fileId);

        let sheet = SpreadsheetApp.openById(spreadsheetId).getActiveSheet();
        sheet.appendRow([fileId, fileName, fileType, caption, uploadedBy, messageLink]);

        telegram.sendMessage(adminBot, `File ${fileName} tersimpan!`); // Menggunakan library

    } catch (error) {
        Logger.log("Error di saveForwardedMessage: " + error.message);
        Logger.log("Stack trace: " + error.stack);
        telegram.sendMessage(adminBot, "Error saat menyimpan file: " + error.message); // Menggunakan library
    }
}

function getMe() {
    let me = telegram.getMe(); //Perubahan
    Logger.log("getMe: " + JSON.stringify(me));
    return me;
}

function setWebhook() {
    var url = "YOUR_WEB_APP_URL"; // GANTI dengan URL Web App kamu setelah deploy!
    var r = telegram.setWebhook(url); //Perubahan
    Logger.log("setWebhook: " + r);
    return r;
}

function getWebhookInfo() {
    let hasil = telegram.getWebhookInfo(); //Perubahan
    Logger.log("getWebhookInfo: " + JSON.stringify(hasil));
    return hasil;
}

function deleteWebhook() {
    let hasil = telegram.deleteWebhook(); //Perubahan
    Logger.log("deleteWebhook: " + hasil);
    return hasil;
}
